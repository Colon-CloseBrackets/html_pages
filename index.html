

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Plan Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Pan/Zoom library -->
<script src="https://unpkg.com/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>

<style>
  :root{
    --ui-bg: rgba(255,255,255,0.94);
    --ui-border:#ddd; --gap:10px; --radius:12px; --shadow:0 6px 20px rgba(0,0,0,0.12);
    --accent:#0b6ef3;
  }
  html,body{height:100%;margin:0;background:#f5f5f7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{padding:12px 16px;display:flex;gap:8px;align-items:center}
  .btn{appearance:none;border:1px solid var(--ui-border);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .wrap{height:calc(100% - 60px);display:grid;grid-template-columns:300px 1fr;gap:12px;padding:0 16px 16px}
  .panel{background:var(--ui-bg);border:1px solid var(--ui-border);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;overflow:auto}
  .viewer{position:relative;background:#fff;border:1px solid var(--ui-border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .viewer.transparent{background:transparent}
  .viewer svg{width:100%;height:100%;display:block;touch-action:none}
  .controls-top{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .layers{display:flex;flex-direction:column;gap:10px}
  .row{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;padding:6px 8px;border:1px solid var(--ui-border);border-radius:8px;background:#fff}
  .row h4{margin:0;font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .row input[type="range"]{width:100%}
  .overlay{position:absolute;left:10px;bottom:10px;display:grid;gap:6px;z-index:5}
  .scale{background:var(--ui-bg);border:1px solid var(--ui-border);border-radius:10px;padding:8px 10px;box-shadow:var(--shadow);font-size:12px}
  .bar{height:6px;border-radius:4px;background:#000;margin-top:6px;position:relative}
  .bar::before,.bar::after{content:"";position:absolute;top:-6px;width:1px;height:18px;background:#000}
  .bar::before{left:0}.bar::after{right:0}
  .viewer:fullscreen,.viewer:-webkit-full-screen{width:100vw;height:100vh;border:none;border-radius:0}
</style>
</head>
<body>

<header>
  <button class="btn" id="btn-fullscreen">Full screen</button>
  <button class="btn" id="reset-view">Reset view</button>
  <button class="btn" id="bg-toggle">Background: White</button>
  <div style="margin-left:auto;font-size:12px;color:#666">Scroll to zoom • Drag to pan • Double-click to zoom</div>
</header>

<div class="wrap">
  <aside class="panel">
    <div class="controls-top">
      <button class="btn" id="show-all">Show all</button>
      <button class="btn" id="hide-all">Hide all</button>
    </div>
    <div class="layers" id="layers"></div>
  </aside>

  <main class="viewer" id="viewer">
    <!-- Scale overlay -->
    <div class="overlay">
      <div class="scale">
        <div id="scale-label">Scale</div>
        <div class="bar" id="scale-bar" style="width:140px"></div>
      </div>
    </div>
    <!-- SVG gets injected here -->
  </main>
</div>

<script>
(async function(){
  // ========= Config =========
const UNITS_PER_METER = 154.99;     // your measured value
window._UNITS_PER_METER = UNITS_PER_METER; // ensure runtime uses it

  const viewer = document.getElementById('viewer');
  const layersEl = document.getElementById('layers');
  const scaleBar = document.getElementById('scale-bar');
  const scaleLabel = document.getElementById('scale-label');
  let panZoom, svgEl;

  // Fetch & inline your SVG (linked images load because they’re same-origin)
  const res = await fetch('28L_SitePlan_02.svg');
  if(!res.ok){ viewer.innerHTML = '<div style="padding:20px;color:#b00;">Failed to load SVG.</div>'; return; }
  const svgText = await res.text();
  viewer.insertAdjacentHTML('beforeend', svgText);

  // Ensure a stable id for scripting
  svgEl = viewer.querySelector('svg');
  if(!svgEl){ viewer.innerHTML = '<div style="padding:20px;color:#b00;">No &lt;svg&gt; found.</div>'; return; }
  if(!svgEl.id) svgEl.id = 'svgRoot';

  // Init pan/zoom
  panZoom = svgPanZoom(svgEl, {
    zoomEnabled:true, panEnabled:true, controlIconsEnabled:true,
    fit:true, center:true, minZoom:0.1, maxZoom:50,
    onZoom:updateScaleBar, onPan:updateScaleBar
  });
  panZoom.zoomBy(1); // kick layout

  // Build layer panel from true Inkscape layers
  buildLayerPanel();

  // UI buttons
  document.getElementById('btn-fullscreen').onclick = toggleFullscreen;
  document.getElementById('reset-view').onclick = resetView;
  document.getElementById('show-all').onclick = () => setAllLayersVisible(true);
  document.getElementById('hide-all').onclick = () => setAllLayersVisible(false);
  document.getElementById('bg-toggle').onclick = toggleBackground;

  updateScaleBar();

  // ======= Functions =======
  function toggleFullscreen(){
    if(!document.fullscreenElement){ viewer.requestFullscreen?.(); }
    else { document.exitFullscreen?.(); }
  }
  function resetView(){
    panZoom.resetZoom(); panZoom.center(); panZoom.fit(); updateScaleBar();
  }
  function toggleBackground(e){
    viewer.classList.toggle('transparent');
    e.target.textContent = 'Background: ' + (viewer.classList.contains('transparent') ? 'Transparent' : 'White');
  }

  function buildLayerPanel(){
    layersEl.innerHTML = '';
    const layerNodes = svgEl.querySelectorAll('g[inkscape\\:groupmode="layer"]');
    layerNodes.forEach((g, idx) => {
      const label = g.getAttribute('inkscape:label') || g.id || `Layer ${idx+1}`;
      if(!g.id) g.id = `layer_${idx+1}`;

      const row = document.createElement('div'); row.className = 'row';

      const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = (g.style.display !== 'none');
      cb.onchange = () => { g.style.display = cb.checked ? '' : 'none'; };

      const title = document.createElement('h4'); title.textContent = label; title.title = label;

      const solo = document.createElement('button'); solo.className = 'btn'; solo.textContent = 'Solo';
      solo.onclick = () => soloLayer(g);

      const sliderWrap = document.createElement('div'); sliderWrap.style.gridColumn = '1 / span 3';
      const slider = document.createElement('input'); slider.type='range'; slider.min=0; slider.max=100;
      const startOpacity = (g.style.opacity ? parseFloat(g.style.opacity) : 1);
      slider.value = Math.round(startOpacity*100);
      slider.oninput = () => { g.style.opacity = (slider.value/100); };

      row.appendChild(cb); row.appendChild(title); row.appendChild(solo);
      sliderWrap.appendChild(slider); row.appendChild(sliderWrap);
      layersEl.appendChild(row);
    });
  }

  function setAllLayersVisible(show){
    const layers = svgEl.querySelectorAll('g[inkscape\\:groupmode="layer"]');
    layers.forEach(g => g.style.display = show ? '' : 'none');
    layersEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = show);
  }

  function soloLayer(target){
    const layers = svgEl.querySelectorAll('g[inkscape\\:groupmode="layer"]');
    const rows = layersEl.querySelectorAll('.row');
    const alreadySolo = Array.from(layers).filter(g => g!==target && g.style.display==='none').length === (layers.length-1);
    if(alreadySolo){ setAllLayersVisible(true); return; }
    layers.forEach((g,i) => {
      const show = (g===target);
      g.style.display = show ? '' : 'none';
      rows[i].querySelector('input[type="checkbox"]').checked = show;
    });
  }

 function updateScaleBar(){
  if(!svgEl || !panZoom) return;
  const UPM = window._UNITS_PER_METER || UNITS_PER_METER; // prefer runtime override if present
  const targetPx = 160;                                    // desired visual width
  const { realZoom } = panZoom.getSizes();                 // px per 1 SVG unit (accounts for viewBox + zoom)

  const units = targetPx / realZoom;                       // how many SVG units fit in targetPx right now
  const nice = niceNumber(units);                          // 1/2/5×10^n “nice” tick

  // draw bar in pixels (nice SVG units * px-per-unit)
  scaleBar.style.width = (nice * realZoom) + 'px';

  if (UPM && UPM > 0) {
    const meters = nice / UPM;                             // convert SVG units → meters
    scaleLabel.textContent = meters >= 1
      ? meters.toFixed(2) + ' m'
      : (meters * 100).toFixed(0) + ' cm';
  } else {
    scaleLabel.textContent = (Math.round(nice*1000)/1000) + ' SVG units';
  }
}

  function niceNumber(x){
    const exp = Math.floor(Math.log10(x));
    const f = x / Math.pow(10, exp);
    let n = (f<1.5)?1:(f<3.5)?2:(f<7.5)?5:10;
    return n * Math.pow(10, exp);
  }
  function formatMeters(m){
    if(m>=1000) return (m/1000).toFixed(2)+' km';
    if(m>=1)    return m.toFixed(2)+' m';
    return (m*100).toFixed(0)+' cm';
  }
})();
</script>
</body>
</html>
